#!/bin/bash
# Instalacja Graylog 6.3.5 na Ubuntu Server 24.04.3
# IP serwera: ....
# Przygotowanie do zbierania logów z FortiGate, retencja 6 miesięcy

# Krok 0: Ustaw strefę czasową
sudo timedatectl set-timezone Europe/Warsaw
echo "Strefa czasowa ustawiona na Europe/Warsaw"

# Krok 1: Aktualizacja systemu i instalacja zależności
sudo apt-get update && sudo apt-get upgrade -y
sudo apt-get install -y curl gnupg openjdk-17-jre-headless uuid-runtime

# Krok 2: Instalacja MongoDB 8.0
curl -fsSL https://www.mongodb.org/static/pgp/server-8.0.asc | sudo gpg -o /usr/share/keyrings/mongodb-server-8.0.gpg --dearmor
echo "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-8.0.gpg ] https://repo.mongodb.org/apt/ubuntu noble/mongodb-org/8.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-8.0.list
sudo apt-get update
sudo apt-get install -y mongodb-org
sudo apt-mark hold mongodb-org
echo "net.bindIpAll: true" | sudo tee -a /etc/mongod.conf
sudo systemctl daemon-reload
sudo systemctl enable mongod.service
sudo systemctl start mongod.service
echo "MongoDB 8.0 zainstalowane i uruchomione"

# Krok 3: Instalacja Graylog Data Node
wget https://packages.graylog2.org/repo/packages/graylog-6.3-repository_latest.deb
sudo dpkg -i graylog-6.3-repository_latest.deb
sudo apt-get update
sudo apt-get install -y graylog-datanode
echo "vm.max_map_count=262144" | sudo tee /etc/sysctl.d/99-graylog-datanode.conf
sudo sysctl --system
PASSWORD_SECRET=$(openssl rand -hex 32)
echo "password_secret = $PASSWORD_SECRET" | sudo tee /etc/graylog/datanode/datanode.conf
echo "opensearch_heap = 4g" | sudo tee -a /etc/graylog/datanode/datanode.conf
echo "mongodb_uri = mongodb://localhost:27017/graylog" | sudo tee -a /etc/graylog/datanode/datanode.conf
sudo systemctl daemon-reload
sudo systemctl enable graylog-datanode.service
sudo systemctl start graylog-datanode.service
echo "Graylog Data Node zainstalowane i uruchomione"

# Krok 4: Instalacja Graylog Server
sudo apt-get install -y graylog-server
ROOT_PASSWORD="TuWpiszHasło" << Zmień to !
ROOT_PASSWORD_SHA2=$(echo -n "$ROOT_PASSWORD" | sha256sum | cut -d" " -f1)
sudo mkdir -p /var/lib/graylog-server
sudo chown graylog:graylog /var/lib/graylog-server
sudo chmod 755 /var/lib/graylog-server
cat <<EOF | sudo tee /etc/graylog/server/server.conf
password_secret = $PASSWORD_SECRET
root_password_sha2 = $ROOT_PASSWORD_SHA2
http_bind_address = adres ip serwera:9000 << zmień to !
data_dir = /var/lib/graylog-server
message_journal_max_age = 72h
message_journal_max_size = 90gb
mongodb_uri = mongodb://localhost:27017/graylog
EOF
echo "GRAYLOG_SERVER_JAVA_OPTS=\"-Xms4g -Xmx4g\"" | sudo tee /etc/default/graylog-server
sudo systemctl daemon-reload
sudo systemctl enable graylog-server.service
sudo systemctl start graylog-server.service
echo "Graylog Server zainstalowane i uruchomione"

# Krok 5: Zapis hasła do pliku dla podglądu
echo "Hasło użytkownika admin: $ROOT_PASSWORD" | sudo tee /root/graylog_admin_password.txt
sudo chmod 600 /root/graylog_admin_password.txt
echo "Hasło zapisane w /root/graylog_admin_password.txt"

# Krok 6: Konfiguracja firewalla (ufw)
sudo apt-get install -y ufw
sudo ufw allow 9000/tcp # Web UI
sudo ufw allow 514/tcp  # Syslog TCP
sudo ufw allow 6514/tcp # Syslog TLS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw allow OpenSSH
sudo ufw --force enable
echo "Firewall skonfigurowany (porty 9000, 514, 6514, 80, 443, SSH)"

# Krok 7: Weryfikacja
echo "Sprawdzanie statusu usług..."
sudo systemctl status mongod.service --no-pager
sudo systemctl status graylog-datanode.service --no-pager
sudo systemctl status graylog-server.service --no-pager
echo "Instalacja zakończona. Wejdź na http://ip serwera:9000 (login: admin, hasło: $ROOT_PASSWORD)"
echo "Sekret: $PASSWORD_SECRET (zapisz w bezpiecznym miejscu)"
echo "Hasło admin zapisane w /root/graylog_admin_password.txt"
