------ Ustawienie strefy czasowej (Europa/Warszawa) -------------------
timedatectl
sudo timedatectl set-timezone Europe/Warsaw
sudo timedatectl status


-------  Aktualizacja systemu --------------
sudo apt update && sudo apt upgrade -y


--------- Zainstaluj zależności -----------
sudo apt install -y curl git docker.io docker-compose
sudo systemctl enable docker --now

----- Konfiguracja vm.max_map_count (dla Wazuh indexer) -----

sudo sysctl -w vm.max_map_count=262144

echo "vm.max_map_count=262144" | sudo tee -a /etc/sysctl.conf


---- Bezpieczeństwo serwera - Włącz firewall (UFW) ---------

* Włączenie UFW (jeśli nie jest aktywne)
sudo ufw --force enable

* Porty do komunikacji z Agentami (Wazuh Manager)
sudo ufw allow 1514/tcp    # Rejestracja agenta
sudo ufw allow 55000/tcp   # Kontrola agenta / Domyślny port agenta
sudo ufw allow 1515/tcp    # Domyślny port dla komunikacji agent-manager (połączenia kontrolne)

* Porty dla Indexer i Dashboard
sudo ufw allow 9200/tcp    # Wazuh Indexer (komunikacja wewnętrzna, warto ograniczyć do 127.0.0.1)
sudo ufw allow 443/tcp     # Wazuh Dashboard (HTTPS - Domyślny port)
sudo ufw allow OpenSSH     # Zezwól na SSH


sudo ufw allow 22/tcp  # SSH
sudo ufw allow 514/udp  # Syslog od Fortigate
sudo ufw allow 443/tcp  # Wazuh dashboard (HTTPS)
sudo ufw allow 80/tcp  # Wazuh dashboard (HTTP)
sudo ufw enable

* Weryfikacja
sudo ufw status


------------Automatyczne aktualizacje bezpieczeństwa--------------------

sudo apt install -y unattended-upgrades
sudo dpkg-reconfigure --priority=low unattended-upgrades


---------------- Instalacja Wazuh przez Docker -------------------

sudo git clone https://github.com/wazuh/wazuh-docker.git -b v4.13.1
sudo cd wazuh-docker/single-node


*Wygeneruj certyfikaty SSL:
sudo docker compose -f generate-indexer-certs.yml run --rm generator


------------------ Dla Dockera ustawienie do pobierania obrazów gdy pokazuje błąd  -------------------------
sudo nano /etc/docker/daemon.json


{
  "registry-mirrors": ["https://mirror.gcr.io"]
}


--------------- Skonfiguruj docker-compose.yml -----------------------

services:
  wazuh.manager:
    image: wazuh/wazuh-manager:4.13.1
    hostname: wazuh-manager
    ports:
      - "10.0.0.3:514:514/udp"  # Syslog od Fortigate
      - "10.0.0.3:1514:1514"    # Agent communication
      - "10.0.0.3:1515:1515"    # Agent enrollment
      - "10.0.0.3:55000:55000"  # API
    volumes:
      - wazuh-data:/var/ossec
    environment:
      - INDEXER_URL=https://wazuh.indexer:9200
      - FILEBEAT_URL=https://wazuh.filebeat:5000
      - TZ=Europe/Warsaw
  wazuh.indexer:
    image: wazuh/wazuh-indexer:4.13.1
    hostname: wazuh-indexer
    ports:
      - "10.0.0.3:9200:9200"  # Elasticsearch
    volumes:
      - indexer-data:/var/lib/wazuh-indexer
    environment:
      - TZ=Europe/Warsaw
  wazuh.dashboard:
    image: wazuh/wazuh-dashboard:4.13.1
    hostname: wazuh-dashboard
    ports: 
      - "10.0.0.3:443:5601"  # HTTPS dashboard
    volumes:
      - dashboard-data:/usr/share/wazuh-dashboard/data
    environment:
      - INDEXER_URL=https://wazuh.indexer:9200
      - WAZUH_API_URL=https://wazuh.manager:55000
      - TZ=Europe/Warsaw
  wazuh.filebeat:
    image: wazuh/wazuh-filebeat:4.13.1
    hostname: wazuh-filebeat
    volumes:
      - filebeat-data:/var/lib/filebeat
    environment:
      - TZ=Europe/Warsaw
volumes:
  wazuh-data:
  indexer-data:
  dashboard-data:
  filebeat-data:
